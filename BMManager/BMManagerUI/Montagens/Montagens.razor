@page "/montagens"
@using BMManagerLN
@using BMManagerLN.SubMontagens
@using BMManagerLN.SubMoveis
@inject APIBMManagerLN ln
@attribute [Authorize(Roles = "Administracao,Montagem,Armazem,Recursos_Humanos")]


<Titulo Nome="Montagens" NomeBotao="Iniciar" UrlBotao="montagens/iniciar"/>
<Tabela TItem="Montagem" Headers="@s" Items="@_montagens" Columns="@c" Botoes= "@b" TItem2 = "Etapa" TItem3 = "Etapa" Items2="@_etapas" Items3="@_etapas" Funcao1 ="@f1" Funcao2 = "@f2"/>

@code {
    private List<Montagem>? _montagens;
    private List<Etapa>? _etapas;
    List<string> s = new List<string> { "Número", "Móvel", "Estado", "Etapa", "Duração", "Data Inicial", "Data final" };
    List<Func<Montagem, object>> c = new List<Func<Montagem, object>> {
                    m => m.Numero,
                    m => m.Movel,
                    m => m.Estado,
                    m => (m.Etapa,m.Movel),
                    m => m.Duracao,
                    m => m.Data_Inicial,
                    m => m.Data_Final};
    Func<List<Etapa>, int, int> f1 = (mo, d2) =>
        mo.FirstOrDefault(n => n.Codigo_Etapa == d2)?.Numero ?? 0;
    Func<List<Etapa>, int, int> f2 = (mo, d2) =>
        mo.Count(n => n.Movel == d2);
    List<(string NomeBotao, string UrlBotao)> b = new List<(string, string)> {
                    ("Visualizar", "montagens/visualizar"),
                    ("Cancelar", "montagens/cancelar"),
                    ("Continuar","montagens/continuar")};

    protected override async Task OnInitializedAsync()
    {
        _montagens = await ln.GetMontagens();
        _etapas = await ln.GetEtapas();
    }
}
